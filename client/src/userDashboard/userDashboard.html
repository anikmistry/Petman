<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PETman</title>
    <meta name="description"
        content="Transform waste management with PETman. Fast, reliable, and eco-friendly waste collection and recycling services for homes and businesses." />
    <link rel="icon" type="image/png" href="./src/assets/petmanlogo.png" />
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css" rel="stylesheet" />
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body class="bg-green-100">
    <header class="sticky top-0 z-50 bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <a href="../../index.html" class="flex items-center gap-3">
                    <img src="../../src/assets/petmanlogo.png" alt="PETman Logo" class="w-10 h-10" />
                    <span class="text-2xl font-bold text-green-600">PETman</span>
                </a>
                <nav class="hidden md:flex items-center gap-8">
                    <a href="../../index.html" class="text-gray-700 hover:text-green-600 transition font-bold">Home</a>
                    <a href="../../index.html#mission"
                        class="text-gray-700 hover:text-green-600 transition font-bold">Mission</a>
                    <a href="../../index.html#traction"
                        class="text-gray-700 hover:text-green-600 transition font-bold">Traction</a>
                    <a href="../../index.html#team" class="text-gray-700 hover:text-green-600 transition font-bold">Our
                        Team</a>
                    <a href="../../index.html#shop"
                        class="text-gray-700 hover:text-green-600 transition font-bold">Shop</a>
                    <a id="dashboard-link" href="#"
                        class="text-gray-700 hover:text-green-600 transition font-bold hidden">Dashboard</a>
                    <!-- <a href="#" class="ml-4 bg-gradient-green text-white px-6 py-2 rounded-lg hover:shadow-lg transition">Get Started</a> -->
                </nav>
                <button id="nav-toggle" class="md:hidden p-2 rounded-lg border border-gray-300">
                    <svg id="nav-open" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    <svg id="nav-close" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="md:hidden hidden border-t bg-gray-50">
            <div class="px-4 py-4 flex flex-col gap-3">
                <a href="../../index.html" class="text-gray-700 py-2 font-bold">Home</a>
                <a href="../../index.html#mission" class="text-gray-700 py-2 font-bold">Mission</a>
                <a href="../../index.html#traction" class="text-gray-700 py-2 font-bold">Traction</a>
                <a href="../../index.html#team" class="text-gray-700 py-2 font-bold">Our Team</a>
                <a href="../../index.html#shop" class="text-gray-700 py-2 font-bold">Shop</a>
                <a id="dashboard-link-mobile" href="#" class="text-gray-700 py-2 font-bold hidden">Dashboard</a>
                <a href="../../index.html" class="mt-2 gradient-green text-white px-6 py-2 rounded-lg text-center">Get
                    Started</a>
            </div>
        </div>
    </header>
    <section class="bg-green-100 h-full w-full relative">
        <div class="max-w-7xl mx-auto">
            <!-- Mobile Dashboard Toggle -->
            <div class="md:hidden p-4 bg-white shadow-sm flex items-center justify-between sticky top-0 z-50">
                <h2 class="text-xl font-bold text-green-600">Dashboard</h2>
                <button id="dashboard-menu-toggle" class="p-2 rounded hover:bg-gray-100">
                    <i class="ri-menu-line text-2xl text-green-600"></i>
                </button>
            </div>

            <div id="maindiv" class="flex min-h-screen relative">
                <!-- Sidebar Overlay -->
                <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

                <!-- Sidebar -->
                <div id="menudiv"
                    class="w-64 bg-green-600 text-white p-4 fixed md:sticky top-0 left-0 z-40 h-screen transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col shrink-0">
                    <div class="flex justify-between items-center mb-6 md:block">
                        <h2 class="text-xl font-bold">Menu</h2>
                        <button id="close-sidebar" class="md:hidden text-white hover:text-gray-200">
                            <i class="ri-close-line text-2xl"></i>
                        </button>
                    </div>
                    <ul class="space-y-4">
                        <li><button id="menu-dashboard"
                                class="w-full text-left py-2 px-4 rounded hover:bg-green-700 transition">Dashboard</button>
                        </li>
                        <li><button id="menu-pickup"
                                class="w-full text-left py-2 px-4 rounded hover:bg-green-700 transition">Pickup</button>
                        </li>
                        <li><button id="menu-profile"
                                class="w-full text-left py-2 px-4 rounded hover:bg-green-700 transition">Profile</button>
                        </li>
                        <li><button id="menu-logout"
                                class="w-full text-left py-2 px-4 rounded hover:bg-green-700 transition bg-red-500 hover:bg-red-600">Logout</button>
                        </li>
                        <li class="mt-auto pt-4 border-t border-green-500 md:hidden">
                            <a href="../../index.html"
                                class="block w-full text-left py-2 px-4 rounded hover:bg-green-700 transition">Back to
                                Home</a>
                        </li>
                    </ul>
                </div>

                <!-- Content Area -->
                <div id="contentdiv" class="flex-1 p-6 bg-white w-full min-h-screen">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </section>
    <script>
        const token = sessionStorage.getItem('authToken');
        const contentDiv = document.getElementById('contentdiv');
        const menuButtons = document.querySelectorAll('#menudiv button:not(#close-sidebar)');

        // Sidebar Elements
        const sidebar = document.getElementById('menudiv');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuToggle = document.getElementById('dashboard-menu-toggle');
        const closeSidebarBtn = document.getElementById('close-sidebar');

        // Toggle Sidebar Function
        function toggleSidebar(show) {
            if (show) {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }
        }

        // Event Listeners for Sidebar
        if (menuToggle) {
            menuToggle.addEventListener('click', () => toggleSidebar(true));
        }
        if (closeSidebarBtn) {
            closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));
        }
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => toggleSidebar(false));
        }

        if (!token) {
            contentDiv.innerHTML = '<p>Error loading dashboard.</p>';
        }

        menuButtons.forEach(button => {
            button.addEventListener('click', () => {
                const menu = button.id.replace('menu-', '');
                // Close sidebar on mobile when a menu item is clicked
                if (window.innerWidth < 768) {
                    toggleSidebar(false);
                }
                loadContent(menu);
            });
        });

        function loadContent(menu) {
            switch (menu) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'pickup':
                    loadPickup();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'logout':
                    logout();
                    break;
            }
        }

        function renderDashboard(stats, period) {
            const periodText = period === 'total' ? 'All Time' : period === 'thisMonth' ? 'This Month' : 'This Year';
            const data = stats[period];
            const totalWaste = data.plasticBottles + data.paperProducts + data.electronics + data.usedClothes + data.metalItems + data.cardboard;
            contentDiv.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-green-600">Dashboard</h1>
                <div class="mb-4">
                    <button id="btn-month" class="bg-blue-500 text-white px-4 py-2 rounded mr-2 ${period === 'thisMonth' ? 'bg-blue-700' : ''}">This Month</button>
                    <button id="btn-year" class="bg-blue-500 text-white px-4 py-2 rounded mr-2 ${period === 'thisYear' ? 'bg-blue-700' : ''}">This Year</button>
                    <button id="btn-total" class="bg-green-500 text-white px-4 py-2 rounded ${period === 'total' ? 'bg-green-700' : ''}">Total</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold mb-2">Total Earnings</h3>
                        <p class="text-3xl font-bold">${data.earned} BDT</p>
                        <p class="text-sm opacity-80">${periodText}</p>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold mb-2">Waste Sold</h3>
                        <p class="text-3xl font-bold">${totalWaste} kg</p>
                        <p class="text-sm opacity-80">${periodText}</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-lg border">
                        <h3 class="text-xl font-bold mb-4 text-gray-700">Waste by Category</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span>Plastic Bottles</span>
                                <span class="font-semibold">${data.plasticBottles} kg</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Paper Products</span>
                                <span class="font-semibold">${data.paperProducts} kg</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Electronics</span>
                                <span class="font-semibold">${data.electronics} kg</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Used Clothes</span>
                                <span class="font-semibold">${data.usedClothes} kg</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Metal Items</span>
                                <span class="font-semibold">${data.metalItems} kg</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Cardboard</span>
                                <span class="font-semibold">${data.cardboard} kg</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            // Add event listeners
            document.getElementById('btn-month').addEventListener('click', () => renderDashboard(stats, 'thisMonth'));
            document.getElementById('btn-year').addEventListener('click', () => renderDashboard(stats, 'thisYear'));
            document.getElementById('btn-total').addEventListener('click', () => renderDashboard(stats, 'total'));
        }

        async function loadDashboard() {
            contentDiv.innerHTML = '<h1 class="text-2xl font-bold mb-4">Dashboard</h1><p>Loading...</p>';
            try {
                const res = await fetch('http://localhost:5000/api/pickups', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const pickups = await res.json();
                    const stats = calculateStats(pickups);
                    renderDashboard(stats, 'total');
                } else {
                    contentDiv.innerHTML = '<p>Failed to load dashboard data.</p>';
                }
            } catch (err) {
                contentDiv.innerHTML = '<p>Error loading dashboard.</p>';
            }
        }

        function calculateStats(pickups) {
            const now = new Date();
            const thisMonth = { plasticBottles: 0, paperProducts: 0, electronics: 0, usedClothes: 0, metalItems: 0, cardboard: 0, earned: 0 };
            const thisYear = { plasticBottles: 0, paperProducts: 0, electronics: 0, usedClothes: 0, metalItems: 0, cardboard: 0, earned: 0 };
            const total = { plasticBottles: 0, paperProducts: 0, electronics: 0, usedClothes: 0, metalItems: 0, cardboard: 0, earned: 0 };

            const prices = {
                'plastic bottles': 15,
                'paper products': 10,
                'electronics': 50,
                'used clothes': 20,
                'metal items': 25,
                'cardboard': 5
            };

            pickups.forEach(pickup => {
                // Only consider completed pickups for stats
                if (pickup.status !== 'completed') return;

                const date = new Date(pickup.createdAt);
                const wasteTypes = Array.isArray(pickup.wasteType) ? pickup.wasteType : [pickup.wasteType];
                const quantity = pickup.quantity;
                const price = prices[wasteTypes[0].toLowerCase()] || 15; // Use first type for price
                const earned = quantity * price;

                wasteTypes.forEach(type => {
                    const category = type.toLowerCase().replace(/\s+/g, '');
                    if (total.hasOwnProperty(category)) {
                        total[category] += quantity;
                        total.earned += earned;
                        if (date.getFullYear() === now.getFullYear()) {
                            thisYear[category] += quantity;
                            thisYear.earned += earned;
                            if (date.getMonth() === now.getMonth()) {
                                thisMonth[category] += quantity;
                                thisMonth.earned += earned;
                            }
                        }
                    }
                });
            });

            return { thisMonth, thisYear, total };
        }

        async function loadPickup() {
            contentDiv.innerHTML = '<div class="flex justify-center items-center h-64"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div></div>';

            try {
                const res = await fetch('http://localhost:5000/api/pickups', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const pickups = await res.json();
                    const pendingPickup = pickups.find(p => p.status === 'pending');

                    if (pendingPickup) {
                        renderInvoice(pendingPickup);
                    } else {
                        renderPickupForm();
                    }
                } else {
                    contentDiv.innerHTML = '<p class="text-red-500 text-center">Failed to load pickup status.</p>';
                }
            } catch (err) {
                console.error(err);
                contentDiv.innerHTML = '<p class="text-red-500 text-center">Error loading pickup section.</p>';
            }
        }

        function renderInvoice(pickup) {
            const date = new Date(pickup.scheduledFor).toLocaleString();
            const wasteTypes = Array.isArray(pickup.wasteType) ? pickup.wasteType.join(', ') : pickup.wasteType;

            contentDiv.innerHTML = `
                <div class="flex justify-center">
                    <div class="w-full max-w-2xl bg-white rounded-3xl shadow-xl p-8 my-10 border border-yellow-200 relative overflow-hidden">
                        <div class="absolute top-0 right-0 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-bl-lg uppercase tracking-wider">
                            Pending
                        </div>
                        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 flex items-center gap-3">
                            <i class="ri-file-list-3-fill text-yellow-500"></i> Pickup Invoice
                        </h1>
                        
                        <div class="space-y-6">
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <p class="text-sm text-gray-500 mb-1">Pickup ID</p>
                                <p class="font-mono text-gray-800 font-bold">#${pickup._id.slice(-6).toUpperCase()}</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Scheduled Time</p>
                                    <p class="text-lg font-semibold text-green-700 flex items-center gap-2">
                                        <i class="ri-time-line"></i> ${date}
                                    </p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Estimated Quantity</p>
                                    <p class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                        <i class="ri-scale-3-line"></i> ${pickup.quantity} kg
                                    </p>
                                </div>
                            </div>

                            <div>
                                <p class="text-sm text-gray-500 mb-1">Waste Types</p>
                                <div class="flex flex-wrap gap-2 mt-1">
                                    ${(Array.isArray(pickup.wasteType) ? pickup.wasteType : [pickup.wasteType]).map(type =>
                `<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium capitalize border border-green-200">${type}</span>`
            ).join('')}
                                </div>
                            </div>

                            ${pickup.details ? `
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Additional Details</p>
                                <p class="text-gray-700 bg-gray-50 p-3 rounded-lg border border-gray-100 italic">"${pickup.details}"</p>
                            </div>
                            ` : ''}

                            <div class="pt-6 border-t border-gray-100 text-center">
                                <p class="text-sm text-gray-500">
                                    Our team will contact you shortly to confirm the pickup.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPickupForm() {
            contentDiv.innerHTML = `
    <div class="flex justify-center">
        <div class="w-full max-w-2xl bg-white rounded-3xl shadow-xl p-8 my-10">
            <h1 class="text-4xl font-extrabold text-green-700 mb-2 flex items-center gap-2">
                <i class="ri-recycle-fill text-3xl"></i> Schedule a Pickup
            </h1>
            <p class="text-gray-500 mb-6">Select the waste types, quantity, and your available time. We'll handle the rest!</p>

            <div class="mb-8">
                <h2 class="text-lg font-bold mb-2 text-green-600 flex items-center gap-2"><i class="ri-checkbox-multiple-fill"></i> Waste Types</h2>
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-gray-50 hover:bg-green-50 cursor-pointer transition">
                        <input type="checkbox" name="wasteType" value="plastic" class="accent-green-600 w-5 h-5">
                        <span class="flex flex-col"><span class="font-semibold">Plastic</span><span class="text-xs text-gray-400">15TK/kg</span></span>
                    </label>
                    <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-gray-50 hover:bg-green-50 cursor-pointer transition">
                        <input type="checkbox" name="wasteType" value="paper" class="accent-green-600 w-5 h-5">
                        <span class="flex flex-col"><span class="font-semibold">Paper</span><span class="text-xs text-gray-400">10TK/kg</span></span>
                    </label>
                    <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-gray-50 hover:bg-green-50 cursor-pointer transition">
                        <input type="checkbox" name="wasteType" value="electronics" class="accent-green-600 w-5 h-5">
                        <span class="flex flex-col"><span class="font-semibold">Electronics</span><span class="text-xs text-gray-400">50TK/kg</span></span>
                    </label>
                    <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-gray-50 hover:bg-green-50 cursor-pointer transition">
                        <input type="checkbox" name="wasteType" value="used_clothing" class="accent-green-600 w-5 h-5">
                        <span class="flex flex-col"><span class="font-semibold">Used Clothes</span><span class="text-xs text-gray-400">20TK/kg</span></span>
                    </label>
                    <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-gray-50 hover:bg-green-50 cursor-pointer transition">
                        <input type="checkbox" name="wasteType" value="metal" class="accent-green-600 w-5 h-5">
                        <span class="flex flex-col"><span class="font-semibold">Metal Items</span><span class="text-xs text-gray-400">25TK/kg</span></span>
                    </label>
                    <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-200 bg-gray-50 hover:bg-green-50 cursor-pointer transition">
                        <input type="checkbox" name="wasteType" value="cardboard" class="accent-green-600 w-5 h-5">
                        <span class="flex flex-col"><span class="font-semibold">Cardboard</span><span class="text-xs text-gray-400">5TK/kg</span></span>
                    </label>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-lg font-bold mb-2 text-green-600 flex items-center gap-2"><i class="ri-scale-2-fill"></i> Estimated Quantity</h2>
                <div class="relative">
                    <button id="selectTrigger" type="button" class="w-full px-4 py-3 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 flex justify-between items-center text-gray-700 font-medium">
                        <span id="selectedText">Select quantity in kg</span>
                        <svg id="dropdownIcon" class="w-5 h-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <ul id="optionsList" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto hidden">
                        <li class="px-4 py-2 text-sm cursor-pointer hover:bg-green-50" data-value="1-2">1-2</li>
                        <li class="px-4 py-2 text-sm cursor-pointer hover:bg-green-50" data-value="3-5">3-5</li>
                        <li class="px-4 py-2 text-sm cursor-pointer hover:bg-green-50" data-value="6-10">6-10</li>
                        <li class="px-4 py-2 text-sm cursor-pointer hover:bg-green-50" data-value="10+">10+</li>
                    </ul>
                    <input type="hidden" id="selectedValue" name="quantity" value="">
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-lg font-bold mb-2 text-green-600 flex items-center gap-2"><i class="ri-time-fill"></i> Available Time</h2>
                <input type="datetime-local" id="availableTime" name="availableTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
            </div>

            <div class="mb-8">
                <h2 class="text-lg font-bold mb-2 text-green-600 flex items-center gap-2"><i class="ri-information-fill"></i> Additional Details</h2>
                <textarea id="details" name="details" rows="3" placeholder="Any additional details..." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"></textarea>
            </div>

            <button id="submitPickup" type="submit" class="w-full bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white font-bold py-3 rounded-xl shadow-lg text-lg transition duration-200 flex items-center justify-center gap-2">
                <i class="ri-calendar-check-fill text-xl"></i> Schedule Pickup
            </button>
        </div>
    </div>
                                `;

            // Custom select functionality
            const selectTrigger = document.getElementById('selectTrigger');
            const optionsList = document.getElementById('optionsList');
            const selectedText = document.getElementById('selectedText');
            const selectedValue = document.getElementById('selectedValue');
            const dropdownIcon = document.getElementById('dropdownIcon');

            selectTrigger.addEventListener('click', () => {
                optionsList.classList.toggle('hidden');
                dropdownIcon.classList.toggle('rotate-180');
            });

            optionsList.addEventListener('click', (e) => {
                if (e.target.tagName === 'LI') {
                    selectedText.textContent = e.target.textContent;
                    selectedValue.value = e.target.dataset.value;
                    optionsList.classList.add('hidden');
                    dropdownIcon.classList.remove('rotate-180');
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!selectTrigger.contains(e.target) && !optionsList.contains(e.target)) {
                    optionsList.classList.add('hidden');
                    dropdownIcon.classList.remove('rotate-180');
                }
            });

            // Submit pickup
            document.getElementById('submitPickup').addEventListener('click', async () => {
                const wasteTypes = Array.from(document.querySelectorAll('input[name="wasteType"]:checked')).map(cb => cb.value);
                const quantity = selectedValue.value;
                const availableTime = document.getElementById('availableTime').value;
                const details = document.getElementById('details').value;

                if (wasteTypes.length === 0 || !quantity || !availableTime) {
                    alert('Please fill in all required fields.');
                    return;
                }

                try {
                    const res = await fetch('http://localhost:5000/api/pickups', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            wasteType: wasteTypes,
                            quantity: parseInt(quantity.split('-')[0]), // Take the lower bound or handle properly
                            details,
                            scheduledFor: availableTime
                        })
                    });

                    if (res.ok) {
                        alert('Pickup scheduled successfully!');
                        loadDashboard(); // Reload dashboard (or reuse loadPickup, which now checks status)
                    } else {
                        const error = await res.json();
                        alert('Failed to schedule pickup: ' + (error.message || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Error scheduling pickup.');
                }
            });
        }

        async function loadProfile() {
            contentDiv.innerHTML = '<h1 class="text-2xl font-bold mb-4">Profile</h1><p>Loading...</p>';
            try {
                const res = await fetch('http://localhost:5000/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const user = await res.json();
                    contentDiv.innerHTML = `
                        <h1 class="text-2xl font-bold mb-4">Profile</h1>
                        <div id="message" class="mb-4 hidden"></div>
                        
                        <form id="profileForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" id="name" value="${user.name || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="email" value="${user.email || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Phone</label>
                                <input type="text" id="phone" value="${user.phone || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Location</label>
                                <input type="text" id="location" value="${user.location || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500">
                            </div>
                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-md transition duration-200">Update Profile</button>
                        </form>
                        
                        <hr class="my-8">
                        
                        <h2 class="text-xl font-bold mb-4">Change Password</h2>
                        <form id="passwordForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Current Password</label>
                                <input type="password" id="currentPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">New Password</label>
                                <input type="password" id="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Confirm New Password</label>
                                <input type="password" id="confirmPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                            </div>
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-200">Change Password</button>
                        </form>
                    `;

                    // Add event listeners for forms
                    document.getElementById('profileForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const messageDiv = document.getElementById('message');
                        messageDiv.classList.add('hidden');

                        const formData = {
                            name: document.getElementById('name').value,
                            email: document.getElementById('email').value,
                            phone: document.getElementById('phone').value,
                            location: document.getElementById('location').value
                        };

                        try {
                            const updateRes = await fetch('http://localhost:5000/api/auth/profile', {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(formData)
                            });

                            if (updateRes.ok) {
                                messageDiv.className = 'mb-4 text-green-600';
                                messageDiv.textContent = 'Profile updated successfully!';
                                messageDiv.classList.remove('hidden');
                            } else {
                                const error = await updateRes.json();
                                messageDiv.className = 'mb-4 text-red-600';
                                messageDiv.textContent = error.message || 'Failed to update profile.';
                                messageDiv.classList.remove('hidden');
                            }
                        } catch (err) {
                            messageDiv.className = 'mb-4 text-red-600';
                            messageDiv.textContent = 'Error updating profile.';
                            messageDiv.classList.remove('hidden');
                        }
                    });

                    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const messageDiv = document.getElementById('message');
                        messageDiv.classList.add('hidden');

                        const newPassword = document.getElementById('newPassword').value;
                        const confirmPassword = document.getElementById('confirmPassword').value;

                        if (newPassword !== confirmPassword) {
                            messageDiv.className = 'mb-4 text-red-600';
                            messageDiv.textContent = 'New passwords do not match.';
                            messageDiv.classList.remove('hidden');
                            return;
                        }

                        const passwordData = {
                            currentPassword: document.getElementById('currentPassword').value,
                            newPassword: newPassword
                        };

                        try {
                            const updateRes = await fetch('http://localhost:5000/api/auth/change-password', {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(passwordData)
                            });

                            if (updateRes.ok) {
                                messageDiv.className = 'mb-4 text-green-600';
                                messageDiv.textContent = 'Password changed successfully!';
                                messageDiv.classList.remove('hidden');
                                document.getElementById('passwordForm').reset();
                            } else {
                                const error = await updateRes.json();
                                messageDiv.className = 'mb-4 text-red-600';
                                messageDiv.textContent = error.message || 'Failed to change password.';
                                messageDiv.classList.remove('hidden');
                            }
                        } catch (err) {
                            messageDiv.className = 'mb-4 text-red-600';
                            messageDiv.textContent = 'Error changing password.';
                            messageDiv.classList.remove('hidden');
                        }
                    });
                } else {
                    contentDiv.innerHTML = '<p>Failed to load profile.</p>';
                }
            } catch (err) {
                contentDiv.innerHTML = '<p>Error loading profile.</p>';
            }
        }

        function logout() {
            sessionStorage.removeItem('authToken');
            window.location.href = '../../index.html';
        }

        // Load dashboard by default
        loadDashboard();
    </script>
</body>

</html>